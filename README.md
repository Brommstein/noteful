Cleaned up a bit of the code and fixed some of the issues per last attempt